# BMAD BMM Workflow: groom-story

**Workflow Type:** Story Grooming  
**Agent:** PM (Product Manager)  
**Phase:** Pre-Implementation  
**Status:** MANDATORY WORKFLOW

## Purpose

Groom a story by breaking it down into implementable tasks and creating them in OpenProject BEFORE implementation begins. This is a mandatory agile practice that must be completed before the story moves to "In progress".

## Workflow Steps

### Step 1: Review Story

1. Get story from OpenProject
2. Review acceptance criteria
3. Identify all tasks needed to complete the story
4. Ensure tasks are granular (30 min - 4 hours of work)
5. Map each task to specific acceptance criteria

### Step 2: Create Story File

1. Create story file in `_bmad-output/implementation-artifacts/`
2. Include all acceptance criteria
3. Break down into tasks with subtasks
4. Map each task to specific acceptance criteria

### Step 3: Create Tasks in OpenProject

**CRITICAL:** All tasks MUST be created in OpenProject during grooming, before story moves to "In progress".

**⚠️ DUPLICATE PREVENTION:** Always check for existing tasks (including closed ones) before creating new tasks.

```python
# Step 3.1: Check for existing tasks (CRITICAL - prevents duplicates)
def check_existing_tasks(story_id: int) -> list[dict]:
    """
    Check for existing tasks for a story, including closed tasks.
    CRITICAL: Use status="all" to include closed tasks.
    """
    children = mcp_openproject_get_work_package_children(
        parent_id=story_id,
        status="all"  # Include closed tasks - CRITICAL!
    )
    return children.get("children", [])

# Get existing tasks
existing = check_existing_tasks(story_id)
existing_subjects = {t["subject"] for t in existing}

# Step 3.2: Define all tasks needed for the story
all_tasks = [
    {
        "subject": "Task 1: [Task Title]",
        "type_id": 36,  # Task
        "description": "Detailed description with acceptance criteria...",
    },
    {
        "subject": "Task X.Y.T: Story X.Y Testing and Validation",  # Test task
        "type_id": 36,  # Task
        "description": """
        **Test Task for Story X.Y**
        
        **Activities:**
        1. Create Story test document: `story-X-Y-test-plan.md`
        2. Attach test document to Story X.Y
        3. Validate all acceptance criteria
        4. Run integration tests
        """,
    },
    # ... all other tasks
]

# Step 3.3: Filter out duplicates
new_tasks = [
    t for t in all_tasks
    if t["subject"] not in existing_subjects
]

if not new_tasks:
    print(f"No new tasks to create for story {story_id} (all tasks already exist)")
else:
    # Step 3.4: Bulk create new tasks
    result = mcp_openproject_bulk_create_work_packages(
        project_id=8,
        work_packages=json.dumps(new_tasks),  # Must be JSON string
        continue_on_error=True
    )
    
    # Step 3.5: Set parent relationships
    for task in result.get("created", []):
        mcp_openproject_set_work_package_parent(
            work_package_id=task["id"],
            parent_id=story_id
        )
```

### Step 4: Verify Tasks Created

1. Verify all tasks are created: `mcp_openproject_get_work_package_children(parent_id=story_id)`
2. Verify all tasks are linked (parent relationship set)
3. Verify task descriptions are complete

### Step 5: Update Story Status

**ONLY after all tasks are created:**

```python
mcp_openproject_update_work_package(
    work_package_id=story_id,
    status_id=77  # In progress
)
```

## Checklist

**Before marking story as "In progress":**

- [ ] Story acceptance criteria reviewed
- [ ] Story broken down into tasks
- [ ] Story file created with all tasks
- [ ] **Checked for existing tasks (including closed) - prevents duplicates**
- [ ] All new tasks created in OpenProject
- [ ] All tasks linked to story (parent relationship)
- [ ] Test task (Task X.Y.T) created
- [ ] Task descriptions include acceptance criteria
- [ ] Story status updated to "In progress" (77)

## Outputs

1. Story file in `_bmad-output/implementation-artifacts/`
2. All tasks created in OpenProject
3. Story marked as "In progress" (ready for Dev)

## Integration with Other Workflows

- **create-story:** Creates story, then calls groom-story
- **sprint-planning:** Grooms stories for sprint, creates tasks
- **dev-story:** Verifies tasks exist before starting implementation

## References

- **Epic-Story Lifecycle:** `@bmad/bmm/workflows/epic-story-lifecycle` - Complete lifecycle requirements
- **Workflow Requirement:** `docs/WORKFLOW_TASK_CREATION_REQUIREMENT.md`
- **Task Management:** `docs/TASK_MANAGEMENT_PROCESS.md`
- **Duplicate Prevention:** `docs/TASK_CREATION_DUPLICATE_PREVENTION.md`
- **QA Testing Workflow:** `docs/QA_TESTING_WORKFLOW.md`
- **Complete Agile Workflow:** `docs/COMPLETE_AGILE_WORKFLOW.md`
- **PM Agent:** `@bmad/bmm/agents/pm`
